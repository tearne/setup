#!/usr/bin/env bash
set -euo pipefail

TOK_DIR="${TOK_DIR:-$HOME/.local/share/tok}"
TIMEOUT=10

# --- Clipboard detection ---

detect_clipboard() {
    if [ -n "${WAYLAND_DISPLAY:-}" ] && command -v wl-copy &>/dev/null; then
        echo "wl-copy"
    elif [ -n "${DISPLAY:-}" ] && command -v xclip &>/dev/null; then
        echo "xclip -selection clipboard"
    elif command -v clip.exe &>/dev/null; then
        echo "clip.exe"
    else
        echo ""
    fi
}

clipboard_clear() {
    local clip="$1"
    if [[ "$clip" == *"wl-copy"* ]]; then
        wl-copy --clear
    elif [[ "$clip" == *"xclip"* ]]; then
        echo -n "" | xclip -selection clipboard
    elif [[ "$clip" == *"clip.exe"* ]]; then
        echo -n "" | clip.exe
    fi
}

usage() {
    cat <<'EOF'
Usage:
  tok                     Retrieve default secret to clipboard
  tok <name>              Retrieve named secret to clipboard
  tok --add (-a)          Add a new secret
  tok --list (-l)         List stored secrets
  tok --stdout            Output secret to stdout instead of clipboard
  tok --time N (-t N)     Set clipboard clear timeout (default: 10s)

Secrets are stored in ~/.local/share/tok/
EOF
}

# --- Parse args ---

ACTION=""
NAME=""
STDOUT=false

while [ $# -gt 0 ]; do
    case "$1" in
        --add|-a)    ACTION="add"; shift ;;
        --list|-l)   ACTION="list"; shift ;;
        --stdout)    STDOUT=true; shift ;;
        --time|-t)   TIMEOUT="$2"; shift 2 ;;
        -*)          echo "Unknown option: $1" >&2; exit 1 ;;
        *)           NAME="$1"; shift ;;
    esac
done

mkdir -p "$TOK_DIR"

# --- Add ---

if [ "$ACTION" = "add" ]; then
    echo -n "Enter secret: " >&2
    read -r secret
    echo -n "Enter passphrase: " >&2
    read -rs passphrase; echo >&2
    echo -n "Confirm passphrase: " >&2
    read -rs confirm; echo >&2

    if [ "$passphrase" != "$confirm" ]; then
        echo "Error: passphrases do not match." >&2
        exit 1
    fi

    if [ ! -f "$TOK_DIR/default.enc" ]; then
        name="default"
    else
        echo -n "Secret name: " >&2
        read -r name
    fi

    # openssl enc -aes-256-cbc -pbkdf2 -salt -pass pass:<passphrase> -out <file>
    echo -n "$secret" | openssl enc -aes-256-cbc -pbkdf2 -salt -pass pass:"$passphrase" -out "$TOK_DIR/$name.enc"
    echo "Secret '$name' stored." >&2
    exit 0
fi

# --- List ---

if [ "$ACTION" = "list" ]; then
    for f in "$TOK_DIR"/*.enc; do
        [ -f "$f" ] || continue
        basename "$f" .enc
    done
    exit 0
fi

# --- Retrieve ---

name="${NAME:-default}"

if [ ! -f "$TOK_DIR/$name.enc" ]; then
    if [ "$name" = "default" ]; then
        usage >&2
    else
        echo "Error: secret '$name' not found." >&2
    fi
    exit 1
fi

echo -n "Passphrase: " >&2
read -rs passphrase; echo >&2

# openssl enc -aes-256-cbc -pbkdf2 -d -pass pass:<passphrase> -in <file>
secret=$(openssl enc -aes-256-cbc -pbkdf2 -d -pass pass:"$passphrase" -in "$TOK_DIR/$name.enc" 2>/dev/null) || {
    echo "Error: decryption failed (wrong passphrase?)." >&2
    exit 1
}

if [ "$STDOUT" = true ]; then
    echo "$secret"
    exit 0
fi

clip=$(detect_clipboard)
if [ -z "$clip" ]; then
    echo "Error: no clipboard tool found (install xclip, wl-copy, or use --stdout)." >&2
    exit 1
fi

echo -n "$secret" | $clip
trap 'clipboard_clear "$clip"; echo "Clipboard cleared." >&2; exit' INT TERM HUP
echo "Secret copied to clipboard. Clearing in ${TIMEOUT}s..." >&2
sleep "$TIMEOUT" &
wait $!
trap - INT TERM HUP
clipboard_clear "$clip"
echo "Clipboard cleared." >&2
